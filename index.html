<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Boulder County Homicides: Official Story vs. Community Memory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html, body {
      margin: 0;
      height: 100%;
      background: #0a0a0a;
      font-family: system-ui, sans-serif;
    }
    #map { position: absolute; inset: 0; }

    /* PANEL */
    .panel {
      position: absolute;
      right: -400px;
      top: 0;
      width: 380px;
      height: 100%;
      background: rgba(15,23,42,0.96);
      border-left: 1px solid rgba(255,255,255,0.15);
      color: white;
      padding: 20px;
      transition: 0.3s;
      overflow-y: auto;
    }
    .panel.open { right: 0; }
    .panel h2 { font-family: Georgia, serif; }

    .hover-label {
      position: absolute;
      display: none;
      padding: 6px 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      font-size: 11px;
      border-radius: 6px;
      pointer-events: none;
    }
  </style>
</head>

<body>

<div id="map"></div>
<div id="hover" class="hover-label"></div>

<div id="info-panel" class="panel">
  <h2 id="panel-title"></h2>
  <p id="panel-summary"></p>
  <p id="panel-location"></p>
  <p id="panel-official"></p>
  <p id="panel-community"></p>
  <a id="panel-link" href="#" target="_blank">Source</a>
</div>

<!-- Core Scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<!-- Heatmap Plugin -->
<script src="https://unpkg.com/leaflet-webgl-heatmap/dist/leaflet-webgl-heatmap.js"></script>

<script>

// Init Map
const map = L.map('map').setView([40.05, -105.28], 11);

L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
  maxZoom: 19,
  attribution: '&copy; CARTO &copy; OpenStreetMap contributors'
}).addTo(map);


// Marker styling
function styleFromCoverage(c) {
  c = (c || "").toLowerCase();
  if (c.startsWith("high")) return { color: "#b91c1c", radius: 14 };
  if (c.startsWith("medium")) return { color: "#f97316", radius: 9 };
  return { color: "#6b7280", radius: 6 };
}


// Panel open function
function openPanel(c) {
  document.getElementById("panel-title").innerText = `${c.case_name} (${c.year})`;
  document.getElementById("panel-summary").innerText = c.summary;
  document.getElementById("panel-location").innerText = c.location;
  document.getElementById("panel-official").innerText = c.official_story;
  document.getElementById("panel-community").innerText = c.community_memory;
  document.getElementById("panel-link").href = c.link;

  document.getElementById("info-panel").classList.add("open");
}


// Hover label
const hover = document.getElementById("hover");

function showHover(e, c) {
  hover.innerText = c.case_name;
  hover.style.display = "block";
}
function moveHover(e) {
  hover.style.left = e.originalEvent.pageX + 10 + "px";
  hover.style.top = e.originalEvent.pageY + 10 + "px";
}
function hideHover() { hover.style.display = "none"; }


// Heatmap layer setup
const heat = L.webGLHeatmap({
  size: 40,
  alphaRange: 0.7,
  units: "px",
  gradientTexture: false,
  gradient: {
    0.0: "#0ff1ce",
    0.5: "#f97316",
    1.0: "#b91c1c"
  }
}).addTo(map);

let heatData = [];


// Load CSV + Add markers + add to heatmap
Papa.parse("https://raw.githubusercontent.com/julianrom/boulder-true-crime-map/main/cases.csv", {
  download: true,
  header: true,
  complete: res => {
    res.data.forEach(c => {
      if(!c.latitude || !c.longitude) return;

      // Add to heatmap
      heatData.push([+c.latitude, +c.longitude, parseInt(c.media_count || 1)]);

      const s = styleFromCoverage(c.media_coverage);

      const marker = L.circleMarker([+c.latitude, +c.longitude], {
        radius: s.radius,
        color: s.color,
        fillColor: s.color,
        fillOpacity: 0.9
      }).addTo(map);

      marker.on("click", () => openPanel(c));
      marker.on("mouseover", e => showHover(e,c));
      marker.on("mousemove", moveHover);
      marker.on("mouseout", hideHover);
    });

    heat.setData(heatData);
  }
});

</script>

</body>
</html>
